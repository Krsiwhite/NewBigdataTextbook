## 5.2 Hive实践

&emsp;&emsp;在本章中，我们将会进行Hive的安装、操作等相关内容的讲解，请确保你已完成了HDFS、ZooKeeper、Yarn三者的配置，并确认Yarn集群能正常执行MapReduce任务。

## 5.2.1 Hive安装

&emsp;&emsp;在本书中，由于广泛使用的Hive3.X版本的生命周期已结束，故综合考虑下采用最新的Hive4.0.1版本完成实验，在Hive4中完全禁用了Hive CLI，故整个的配置过程与网络上流行的教程有比较大不同。由于本书的环境属于小规模的集群，所以选择的运行模式为本地模式（Local Mode），这意味着我们还需要在本地安装SQL数据库，在本书中选用的是MySQL。安装过程需要做的工作大致如下：

1. 安装MySQL
2. 修改Hadoop配置环境以适配Hive
3. 安装Hive
4. 修改Hive配置环境
5. 连接MySQL，初始化元数据
6. 写下我们的第一条HQL语句
   
**（1） 安装MySQL**

&emsp;&emsp;在`m1`上安装MySQL服务端以及客户端。

```shell
sudo apt-get install mysql-server
sudo apt-get install mysql-client
```

&emsp;&emsp;安装完成后，MySQL应该已经默认启动，可以使用命令`service mysql status`查看状态，显示 active（running）证明MySQL正常运行。

```shell
root@m1:~# service mysql status
● mysql.service - MySQL Community Server
     Loaded: loaded (/usr/lib/systemd/system/mysql.service; enabled; preset: enabled)
     Active: active (running) since Wed 2025-05-28 15:13:53 CST; 27min ago
    Process: 1013 ExecStartPre=/usr/share/mysql/mysql-systemd-start pre (code=exited, status=0/SUCCESS)
   Main PID: 1221 (mysqld)
     Status: "Server is operational"
      Tasks: 37 (limit: 4006)
     Memory: 430.9M (peak: 441.0M)
        CPU: 2.891s
     CGroup: /system.slice/mysql.service
             └─1221 /usr/sbin/mysqld

May 28 15:13:52 m1 systemd[1]: Starting mysql.service - MySQL Community Server...
May 28 15:13:53 m1 systemd[1]: Started mysql.service - MySQL Community Server.

```

&emsp;&emsp;MySQL的超级用户root默认未设置密码，使用命令`sudo mysql -u root`登录。并使用`select version();`查看版本。

```shell
root@m1:~# sudo mysql -u root
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 13
Server version: 8.0.42-0ubuntu0.24.04.1 (Ubuntu)

Copyright (c) 2000, 2025, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> select version();
+-------------------------+
| version()               |
+-------------------------+
| 8.0.42-0ubuntu0.24.04.1 |
+-------------------------+
1 row in set (0.00 sec)
```

&emsp;&emsp;由于Linux下MySQL的默认root用户认证方式使用`auth_socket`，而Hive可能不支持，故我们需更改认证方式并设定密码，最后刷新更改。

```
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'yourpassword';
FLUSH PRIVILEGES;
```

&emsp;&emsp;最后退出MySQL并重启MySQL服务。

```
mysql> exit;
Bye
root@m1:~# sudo systemctl restart mysql
```

**（2） 修改Hadoop配置环境以适配Hive**

&emsp;&emsp;在这步中，我们需要修改的配置文件`core-site.xml`。其在hadoop根目录下的`/etc/hadoop`文件夹中，在配置文件中新增：

```xml
    <property>
        <name>hadoop.proxyuser.root.hosts</name>
        <value>*</value>  <!-- 允许来自任何主机的 root 用户代理 -->
    </property>
    <property>
        <name>hadoop.proxyuser.root.groups</name>
        <value>*</value>  <!-- 允许 root 代理任何用户组的用户 -->
    </property>

```

&emsp;&emsp;同时，在HDFS中创建Hive保存数据所需文件夹：

```shell
hdfs dfs -mkdir -p /user/hive/warehouse 
hdfs dfs -mkdir -p /tmp/hive/ 
hdfs dfs -chmod 750 /user/hive/warehouse 
hdfs dfs -chmod 777 /tmp/hive
```

**（3） 安装Hive**

&emsp;&emsp;在清华镜像源下载Hive4.0.1到root目录下，并解压，为统一命名将其命名为`hive-4.0.1`。

```shell
wget https://mirrors.tuna.tsinghua.edu.cn/apache/hive/hive-4.0.1/apache-hive-4.0.1-bin.tar.gz
tar -zxvf apache-hive-4.0.1-bin.tar.gz
mv apache-hive-4.0.1-bin hive-4.0.1
```

&emsp;&emsp;之后配置环境变量，编辑`/etc/profile`，在文件末尾添加如下内容，之后使用命令`source /etc/profile`激活环境变量。

```
export HIVE_HOME=/root/hive-4.0.1
export PATH=$PATH:$HIVE_HOME/bin
```

&emsp;&emsp;输入命令`hive version`，出现以下内容说明安装成功。

```shell
root@m1:~# hive version
Beeline version 4.0.1 by Apache Hive
```

&emsp;&emsp;如果出现如下关于SLF4j的警告，这是因为HBase，Hadoop和Hive都有自己内置的SLF4j（这是一个日志管理组件）库，绑定了多个版本导致的，不影响程序正常运行。

```
SLF4J: Class path contains multiple SLF4J bindings.
SLF4J: Found binding in [jar:file:/root/hive-4.0.1...]
SLF4J: Found binding in [jar:file:/root/hadoop-3.3.6...]
SLF4J: Actual binding is of type [org.apache...]
SLF4J: Class path contains multiple SLF4J bindings.
```

**（3） 安装Hive**

&emsp;&emsp;我们需要修改的配置文件均位于`hive-4.0.1/conf`下，在该目录下我们新建两个文件：
* `hive-site.xml`
* `hive-env.sh`

&emsp;&emsp;`hive-site.xml`填入以下内容：

```shell
<?xml-stylesheet type="text/xsl" href="configuration.xsl"?>
<configuration>
  <property>
    <name>javax.jdo.option.ConnectionURL</name>
    <value>jdbc:mysql://localhost:3306/hive?createDatabaseIfNotExist=true</value>
    <description>Metadata store connection URL</description>
  </property>
  <property>
    <name>javax.jdo.option.ConnectionDriverName</name>
    <value>com.mysql.cj.jdbc.Driver</value>
    <description>Metadata store JDBC driver</description>
  </property>
  <property>
  <!-- 连接用户名，本书为root -->
    <name>javax.jdo.option.ConnectionUserName</name>
    <value>root</value>
    <description>Metadata store username</description>
  </property>
  <property>
  <!-- 这里修改为上一步mysql中设置的密码 -->
    <name>javax.jdo.option.ConnectionPassword</name>
    <value>yourpassword</value>
    <description>Metadata store password</description>
  </property>
  <!-- hive默认在hdfs的工作目录 -->
  <property>
    <name>hive.metastore.warehouse.dir</name>
    <value>/user/hive/warehouse</value>
  </property>
  <!-- 指定hiveserver2连接的host -->
  <property>
    <name>hive.server2.thrift.bind.host</name>
    <value>m1</value>
  </property>
  <!-- 指定hiveserver2连接的端口号 -->
  <property>
    <name>hive.server2.thrift.port</name>
    <value>10000</value>
  </property>
  <property>
    <name>hive.metastore.uris</name>
    <value>thrift://localhost:9083</value>
  </property>
  <!-- hiveserver2的高可用参数，如果不开会导致了开启tez session导致hiveserver2无法启动 -->
  <property>
    <name>hive.server2.active.passive.ha.enable</name>
    <value>true</value>
  </property>
  <!--解决Error initializing notification event poll问题-->
  <property>
    <name>hive.metastore.event.db.notification.api.auth</name>
    <value>false</value>
  </property>
  <property>
    <name>hive.server2.enable.doAs</name>
    <value>false</value>  <!-- 启用用户代理 -->
  </property>
</configuration>

```

&emsp;&emsp;`hive-env.sh`填入以下内容，注意各个环境变量应设置为读者机器中对应的路径。

```sh
export HIVE_CONF_DIR=/root/hive-4.0.1/conf
export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
export HADOOP_HOME=/root/hadoop-3.3.6
export HIVE_AUX_JARS_PATH=/root/hive-3.3.6/lib
```

&emsp;&emsp;接下来下载MySQL驱动Jar包，如果使用该数据库作为元数据存储位置，需要使得Hive能够连接到数据库，因此需要在lib目录下放入驱动jar包，可以使用wget直接下载。注意该文件需放入`hive-4.0.1/lib`目录下。

&emsp;&emsp;`wget https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/8.0.32/mysql-connector-j-8.0.32.jar`

**（5） 连接MySQL，初始化元数据**

&emsp;&emsp;首先执行初始化Hive元数据。

&emsp;&emsp;`schematool -initSchema -dbType mysql`

&emsp;&emsp;等待，直到输出`Initialization script completed`则为初始化成功。

&emsp;&emsp;随后依次启动ZooKeeper集群、HDFS集群和Yarn集群。

```
start-dfs.sh
start-yarn.sh
```

&emsp;&emsp;接着启动HiveServer2和metastore服务，它们分别负责启动Hive服务端和与MySQL通信维护元数据。

```
hive --service metastore
hive --service hiveserver2
```

