### 2.4.1 HBase介绍

&emsp;&emsp;HBase (Hadoop Database) 是一种构建在 Hadoop 分布式文件系统 (HDFS) 之上的、高可靠性、高性能、面向列、可伸缩的分布式存储系统。它最初的设计灵感来源于谷歌的 Bigtable 论文，旨在为大规模结构化数据集提供随机、实时的读写访问。

**1. HBase 与 NoSQL**

&emsp;&emsp;NoSQL（Not Only SQL）泛指非关系型数据库，它们通常不保证关系数据库的ACID特性（原子性、一致性、隔离性、持久性），但能更好地满足大规模数据集合的多种数据种类存储与访问的需求。HBase 是 NoSQL 数据库家族中的一员，属于列式存储数据库。

&emsp;&emsp;与传统的关系型数据库 (RDBMS) 相比，HBase 具有以下特点：

* **数据模型灵活**：HBase 的表是稀疏的，模式是动态的。你可以在定义表时只指定列族，而具体的列可以在数据写入时动态添加，不同行可以拥有不同的列。
* **高可扩展性**：HBase 能够通过在集群中增加通用硬件来线性扩展，支持PB级别的数据存储。
* **面向列存储**：数据在物理上是按列族存储的，这使得针对特定列族的查询效率非常高。
* **稀疏性**：对于空值，HBase不会占用存储空间，这对于那些列很多但大部分行为空的表来说非常高效。
* **高并发**：能够支持高并发的实时读写请求。

**2. HBase 与 HDFS**

&emsp;&emsp;HBase 利用 HDFS 作为其底层的文件存储系统。HDFS 为 HBase 提供了以下关键能力：

* **数据持久化**：HBase 的数据文件（HFile）最终存储在 HDFS 上，确保了数据的可靠性和持久性。
* **容错性**：HDFS 通过数据块复制机制来保证数据的冗余备份，即使部分节点发生故障，数据也不会丢失。
* **可扩展性**：HDFS 本身就是为大规模数据存储设计的，其可扩展性为 HBase 存储海量数据提供了基础。

&emsp;&emsp;简单来说，HDFS 负责数据的存储和冗余，而 HBase 在 HDFS 之上提供了对数据的结构化组织、随机访问和管理能力。

**3. HBase 内部组件**

<p align="center">
    <img src="/pic/2/2-11 HBase架构图.png" width="60%">
    <br/>
    <em>图2-11 HBase架构图</em>
</p>

&emsp;&emsp;HBase 主要由以下几个核心组件构成：

* **HMaster (主节点)**：
  * 负责管理 HBase 集群中的所有 RegionServer。
  * 处理元数据的变更，例如表的创建、删除和修改。
  * 分配 Region 到 RegionServer，并进行负载均衡。
  * 监控 RegionServer 的状态，并在 RegionServer 发生故障时进行故障转移。
* **RegionServer (区域服务器)**：
  * 负责存储和管理分配给它的 Region。
  * 处理客户端的读写请求。
  * 负责 Region 的切分 (Split) 和合并 (Compact)。
  * 与 HDFS 交互，将数据持久化到 HDFS。
* **ZooKeeper (协调服务)**：
  * HBase 依赖 ZooKeeper 进行分布式协调。
  * 存储 HBase 的元数据信息，例如 `-ROOT-` 表 (HBase 0.96版本之前) 或 `hbase:meta` 表的位置。
  * 监控 HMaster 和 RegionServer 的状态，实现 HMaster 的选举和故障恢复。
  * 确保集群中只有一个 Active HMaster。
* **Client (客户端)**：
  * 提供访问 HBase 的接口，与 HMaster 和 RegionServer 进行通信。
  * 对于管理类操作（如创建表、删除表），客户端与 HMaster 通信。
  * 对于数据操作（如读写数据），客户端与 RegionServer 通信。
  * 客户端会缓存 Region 的位置信息，以减少对元数据的查询。

**4. HBase 功能**

&emsp;&emsp;HBase 主要提供以下功能：

* **大规模数据存储**：能够存储和管理 PB 级别的海量数据。
* **实时随机读写**：支持对大规模数据的快速随机读写访问。
* **自动分片 (Sharding)**：当表中的数据量增长到一定程度时，HBase 会自动将表水平切分成多个 Region，并分布到不同的 RegionServer 上，实现数据的自动分片和负载均衡。
* **高可用性**：通过 HMaster 的主备机制和 RegionServer 的故障转移机制，保证了集群的高可用性。
* **数据版本控制**：HBase 会为每个单元格 (Cell) 的数据保留多个版本，版本通过时间戳来区分。
* **稀疏表支持**：有效地存储那些包含大量空值的稀疏数据。
* **与 Hadoop 生态集成**：可以与 Hadoop MapReduce、Apache Hive、Apache Pig 等 Hadoop 生态系统组件无缝集成，进行数据的批量处理和分析。

**5. HBase 基本概念**

&emsp;&emsp;理解 HBase 的一些基本概念对于使用 HBase至关重要：

* **表 (Table)**：HBase 中数据的组织形式，类似于关系数据库中的表，但更加灵活。
* **行键 (Row Key)**：表中每一行的唯一标识符。行键是字节数组，HBase 中的数据按照行键的字典序排序。行键的设计对 HBase 的性能至关重要。
* **列族 (Column Family)**：列的集合。在创建表时需要预先定义列族。同一列族的数据在物理上存储在一起。列族影响 HBase 的存储和性能特性。
* **列限定符 (Column Qualifier)**：列族中的具体列的名称。列限定符是字节数组，可以在数据写入时动态指定，无需预先定义。一个列族可以包含任意数量的列。
* **单元格 (Cell)**：由行键、列族、列限定符和时间戳唯一确定的数据存储单元。每个单元格可以存储多个版本的数据。
* **时间戳 (Timestamp)**：用于标识单元格中不同版本数据的 64 位整数。默认情况下，时间戳是数据写入时的系统时间。HBase 会根据时间戳保留数据的多个版本，并按时间戳降序排列，最新的版本最先被读取。
* **命名空间 (Namespace)**：对表进行逻辑分组的一种方式，类似于关系数据库中的数据库。

### 2.4.2 HBase基础操作实践

**（1）操作环境**

&emsp;&emsp;服务器规格： Ubuntu 24.04 server 64bit 节点数⽬：3

&emsp;&emsp;Hadoop 版本： Apache Hadoop 3.3.6

&emsp;&emsp;zookeeper 版本： 3.8.4

&emsp;&emsp;HBase 版本： 2.5.11

**（2）操作步骤**

**1.启动 Hadoop、HBase 及 zookeeper：**

&emsp;&emsp;在 **所有节点** 都运⾏ `zkServer.sh start` 以启动 zookeeper;

&emsp;&emsp;在 **节点 m1**运⾏ `start-all.sh` 以启动 Hadoop集群;

&emsp;&emsp;启动后⽤ `zkServer.sh status` 和 `jps` 命令检查各个服务是否正常启动;

**2.使⽤ HBase Shell连接 HBase：**

&emsp;&emsp;在 **节点 m1**运⾏ `start-hbase.sh` 启动 HBase 服务；

&emsp;&emsp;运⾏ `hbase shell` 进⼊ hbase shell, 接下来关于 hbase的数据操作命令都是在 hbase shell中执⾏。

**3.HBase 操作：**

&emsp;&emsp;创建表 student，设置 2个列簇，分别为 stuinfo 和 course，并显示表结构:

```shell
# 创建表 
create 'student',{NAME=>'stuinfo'},{NAME=>'course'}

#查看表结构
describe 'student' 
```

&emsp;&emsp;修改表结构，course 列簇返回最⼤版本数为 3，并显示表结构：

```shell
# 修改表结构
alter 'student',{NAME=>'course',VERSIONS=>3} 

describe 'student'
```

&emsp;&emsp;向列簇中增加列：

```shell
stuinfo 列簇: name,age,sex,dept 
course 列簇: english,math,physics
```

&emsp;&emsp;由于 HBase是采⽤动态添加列，在插⼊数据的同时插⼊列，因此步骤 3 和步骤 4 统⼀放在步骤 4 完成。

&emsp;&emsp;向表中添加数据，添加四条学⽣信息:

```shell
put 'student','1','stuinfo:name','laowang' 
put 'student','1','stuinfo:age','18'
put 'student','1','stuinfo:sex','male'
put 'student','1','stuinfo:dept','CS'
put 'student','1','course:english','100' 
put 'student','1','course:math','90'
put 'student','1','course:physics','80'
put 'student','2','stuinfo:name','chris' 
put 'student','2','stuinfo:age','36'
put 'student','2','stuinfo:sex','male' 
put 'student','2','stuinfo:dept','CS' 
put 'student','2','course:english','90' 
put 'student','2','course:math','80'
put 'student','2','course:physics','100'
```

&emsp;&emsp;Note: 由于命令过多且格式相同，故只列出部分命令，都按照 `put 表名, ⾏号, 列簇: 列名, 数据`
的格式插⼊数据。`<p align="center">`
    `<img src="/pic/2/2-4 学生表.png" width="50%">`
    `<br/>`
    `<em>`图2-4 学生信息表`</em>`

</p>

&emsp;&emsp;添加完数据后，⽤ scan 命令查询 student 表中的所有信息：

```shell
# 查询表信息
scan 'student' 
```

&emsp;&emsp;添加完数据后，查询 student 表中指定列簇或列簇中某个列的所有信息：

```shell
# 查询 stuinfo 列簇中的所有信息 
scan 'student', {COLUMN=>'stuinfo'} 

# 查询 stuinfo:sex 列中的所有信息
scan 'student', {COLUMN=>'stuinfo:sex'} 

# 通过 LIMIT 限定查询到的⾏数
scan 'student', {LIMIT=>2, COLUMN=>'stuinfo'} 
```

&emsp;&emsp;更新数据，将 course 列簇中的 english 列的值减 5：

```shell
put 'student','1','course:english','95'
```

&emsp;&emsp;Note：HBase ⽆法统⼀修改数据，只能⼀个个数据重新赋值。

&emsp;&emsp;使⽤ get 查询指定⾏对应列簇或列的信息：

```shell
# 查询第 "1" ⾏ course列簇的信息
get 'student', '1', 'course' 

# 查询第 "1"⾏ course列簇中 english列的信息
get 'student', '1', 'course:english'  

# 查询第 "1"⾏中所有信息
get 'student, '1' 
```

&emsp;&emsp;删除 student 表：

```shell
# 先使表失效，才能删除
disable 'student' 

# 删除表
drop 'student'
```
