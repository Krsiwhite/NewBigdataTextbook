## 6.1 电影评论情感倾向与用户评价关联性初探

### 6.1.1 实验背景

&emsp;&emsp;在电影行业，院线电影的票房高度依赖观众口碑。及时准确地把握观影观众对电影的情感反馈，对于电影宣发、排片策略、后续创作乃至整个行业的健康发展都至关重要。我们可以使用爬虫结合大数据技术爬取电影网站各电影的评论来分析观影观众的情感倾向，从而调整后续上映策略。

&emsp;&emsp;但同时，在观影后写下评论的用户或许是少数，但多数用户都会习惯性地在购票APP上进行打分，而此评分是一个好像更为有用、更为直观的指标，打分的高低直接决定了电影口碑的好坏，直接统计观众的均分似乎更为有效。然而，仅仅依赖数字化的平均评分，可能无法全面地捕捉到电影真实口碑。

&emsp;&emsp;首先，数字评分的“颗粒度”相对较粗。一个简单的3星、4星或5星，背后可能隐藏着截然不同的观影体验。例如，同样是给出4星评价，有的观众可能是因为整体满意但略有瑕疵，有的则可能是被某一突出亮点（如演员表现或视觉特效）所打动，但对剧情本身并不完全认可。平均分抹平了这些差异，使得我们难以洞察观众满意的具体原因和不满意的具体环节。

&emsp;&emsp;其次，评分行为本身可能受到多种因素的影响，其客观性和深度值得进一步探究。例如，部分购票平台可能存在“默认好评”的机制，或者用户在完成购票、观影流程后，出于习惯或图方便，随手给出一个大致的评分，并未经过深思熟虑。这种“便捷性”带来的评分，其所承载的真实情感反馈的“浓度”和“准确度”可能会打折扣。一个典型的例子是，我们观察到如猫眼电影这类平台的平均评分，往往普遍高于像豆瓣这样以深度影评和社区讨论为核心的平台。单纯的平均分可能存在“虚高”或未能反映真实口碑全貌的风险，而像豆瓣这样的平台，其均分在电影上映初期是不予公布的，无法为上映策略提供参考。

&emsp;&emsp;相比之下，用户花费时间和精力写下的评论文本，往往蕴含着更为丰富和真实的情感信息。评论者通常是那些有较强表达意愿的观众，他们愿意沉下心来，用文字描述自己的观影感受、具体的好恶点、甚至是引发的思考，如此的影评应该说对于反映整个电影的口碑更具参考价值。

&emsp;&emsp;那么落实到算法，我们如何来通过评论来得知电影口碑如何呢？

&emsp;&emsp;评论文本一般而言包含了整体的情感倾向（喜欢、不喜欢、一般），我们可以通过设立情感字典来识别评论文本中反映的情感偏向，例如出现一个正面情绪词则情感分加一分，出现一个负面情绪词则情感分减一，最终得到每条评论的情感分，一部电影所有评论的情感分可以算得该电影的情感均分。按照我们之前的说法，电影的情感均分应能反映电影口碑的好坏，也就是其和豆瓣平台上该电影的评分应呈现显著的正相关。

&emsp;&emsp;那么，这就是我们的第一次实验，我们需要利用大数据技术统计电影评论的情感偏向，在最后我们预期的结果是电影的情感分应该和其评分成正相关。

### 6.1.2 实验准备

&emsp;&emsp;本次实验所使用的数据集包含豆瓣电影网站 28 部电影的超过 200 万条短评论，其为`csv`格式，内容大致如图6-1所示：

<p align="center">
    <img src="/pic/6/6-1 所用数据集形式.png" width="50%">
    <br/>
    <em>图6-1 所用数据集形式</em>
</p>

&emsp;&emsp;在其中，每行为一条评论，一行中有以下属性：

1. 该条评论在数据集中的编号：`ID`，`Number`
2. 该评论对应的电影英文名：`Movie_Name_EN`
3. 该评论对应的电影中文名：`Movie_Name_CN`
4. 该评论对应的用户名：`UserName`
5. 该评论产生日期：`Date`
6. 该评论的打分：`Star`
7. 该评论的具体内容：`Comment`
8. 该评论被点赞数量：`Like`

&emsp;&emsp;在进行评论的情感偏向统计时，我们会用到三个字典，字典为`txt`文本文件，为`UTF-8`编码，每行一个词汇，如图6-2所示。

* 停用词字典：‌Stopwords（停用词）是指在自然语言处理（NLP）和信息检索中被预先过滤掉的常见高频词汇‌，如介词、连词、代词等，因其信息量低且可能干扰分析效果。例如中文的“的”、“在”、“和”或英文的“the”、“a”、“and”等。
* 正面评价词字典：包含用于统计的所有正面情感词，当评论文本中出现字典包含词语时，情感分加一。该字典来自知网Hownet情感词典。
* 负面评价词字典：包含用于统计的所有负面情感词，当评论文本中出现字典包含词语时，情感分减一。该字典来自知网Hownet情感词典。

<p align="center">
    <img src="/pic/6/6-2 字典格式.png" width="50%">
    <br/>
    <em>图6-2 字典格式</em>
</p>

&emsp;&emsp;在准备好了所有所需数据后，我们来接着思考接下来会需要哪些组件。首先，我们肯定需要一个文件系统来存储原始数据和最终产生的结果，故需要HDFS集群。接着，由于处理的是已有的两百万条数据，并且我们对耗时和实时性无需求，那么我们需要的便是一个批处理框架，在这里，我们选择使用Spark引擎，期望其能带来更快的处理速度。

&emsp;&emsp;Spark处理完成后，我们需要决定输出结果如何存储，是存储到文件中，还是存储到数据仓库中。这首先取决于我们想要哪些输出：

1. 由于我们的原始数据是格式化的`csv`，那么我们可以在处理时将原数据存储进Hive数据仓库中，便于后续可能的进一步分析。同时对于每一条数据（每一行），我们也可以存储其评论对应的情感打分，接着对应该打分的情感偏向(positive, negative, neutral)也可以一并纪录。
2. 另外，我们最终的目的是得到每个电影的情感均分，以及按电影分类的各个信息，这需要我们新创建一个表来存储。
3. 这些数据同样也可以以格式化的形式输出到`csv`文件中。
4. 额外做一些附加任务，我们也可以统计每部电影点赞数前五的正面/负面情感评论，这可以保存在`json`文件中。

&emsp;&emsp;总结一下，需要在Hive中存储上述两个表，并将按电影分类的各信息同时存储到`csv`文件中，最后做一些额外的工作，统计每部电影点赞数前五的正面/负面情感评论，保存在`json`文件。那么用到的所有组件如下：

* Spark
* Hive
* HDFS
* YARN
* ZooKeeper

### 6.1.3 正式开始实验

**（1） 准备数据**

&emsp;&emsp;将我们准备好的数据上传到HDFS集群，这里统一上传到文件夹`/exp_data/1`：

```shell
hdfs dfs -mkdir /exp_data/1
hdfs dfs -put negative_words.txt /exp_data/1
hdfs dfs -put positive_words.txt /exp_data/1
hdfs dfs -put stopwords.txt /exp_data/1
hdfs dfs -put DMSC.csv /exp_data/1
```



**（2） 理清代码思路**

&emsp;&emsp;接着我们需要规划好代码中需要哪些函数，这些函数应该完成怎样的功能。这需要从我们的流程出发，看看我们按序需要完成哪些操作。总体来说，我们的程序流程应该如下：

1. 初始化与环境配置：加载必要的外部资源，如情感词典和停用词词典。

2. 数据加载与预处理：从HDFS读取原始的电影评论CSV数据到RDD中。对原始数据进行初步清洗和转换，例如选择需要的列、统一列名、转换数据类型，并处理可能存在的空值或无效数据。

3. 核心情感分析：
    * 文本预处理：对评论文本进行标准化处理，包括去除无关字符（如标点符号、非中文字符）、中文分词（将连续的文本切分成词语序列）、以及去除停用词。
    * 情感打分：基于预处理后的词语列表和加载的情感词典（正面词典、负面词典），为每条评论计算一个量化的情感得分。并据计算出的情感得分，将每条评论归类为“正面”、“负面”或“中性”等情感标签。

4. 结果聚合与分析：按电影ID分组，统计每部电影的正面评论数、负面评论数、中性评论数、总评论数、平均情感得分、平均原始星级评分以及总点赞数等摘要信息。
   
5. 数据持久化与输出：将详细的每条评论的情感分析结果（包括原始评论、情感得分、情感标签等）存入一个Hive分区表中，便于后续的细粒度查询和历史追溯。将聚合得到的电影情感摘要信息存入另一个Hive表中，供快速查询和报表分析使用。

6. 写入HDFS文本文件：将电影情感摘要信息以CSV格式输出到HDFS；将每部电影的Top N条热门（例如按点赞数排序）正面和负面评论以JSON格式输出到HDFS。

&emsp;&emsp;综合该流程，我们规划出以下几个主要函数：

1. `load_words_from_hdfs(spark, path)`函数，





















