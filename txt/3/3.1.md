## 2.1 MapReduce的编程思想

&emsp;&emsp;我们首先回答第一个问题，也就是主备NameNode是如何接替的，不知大家是否注意到，每个NameNode节点所在主机上都存在着一个DFSZKFailoverController节点（以下简称ZKFC），其实，ZKFC节点相当于ZooKeeper集群和 HDFS 集群交互的桥梁。主备交替由其和ZooKeeper集群（也就是QuorumPeerMain节点）共同完成。接下来让我们来看ZKFC节点的内部构成：

&emsp;&emsp;ZKFC内部存在 `HealthMonitor` 、`ActiveStandbyElector`和`FailoverController` 这三个主要组件。它们各自的作用如下：
* `HealthMonitor`主要负责检测 NameNode 的健康状态，并将状态变换通知``ZKFailoverController``。
* `ZKFailoverController`控制着NameNode状态切换的开关，一旦检测到NameNode状态变换，便告知`ActiveStandbyElector`需要选举。
* `ActiveStandbyElector`主要负责与ZooKeeper集群交互，需要选举时告知ZooKeeper集群，并接受选举结果并通知``ZKFailoverController``。
 
&emsp;&emsp;如图2-7所示，切换的流程大致可描述如下：
1. `HealthMonitor`对 NameNode 的健康状态进行检测，当检测到 NameNode的健康状态发生变化（即宕机），会通知`ZKFailoverController`。
2. `ZKFailoverController`判断需要进行主备切换，使用 `ActiveStandbyElector` 来与 Zookeeper集群进行交互完成自动的主备选举。
3. `ActiveStandbyElector`在主备选举完成后，会通知`ZKFailoverController`当前的 NameNode 成为主 NameNode 或备 NameNode。
4. `ZKFailoverController`将 NameNode 转换为 Active 状态或 Standby 状态。 

<p align="center">
    <img src="pic/2/2-7 NameNode的主备切换流程.jpg" width="50%">
    <br/>
    <em>图2-7 NameNode的主备切换流程 </em>
</p>