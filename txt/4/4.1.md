## 4.1 流处理/批处理区别：着急or不着急 

&emsp;&emsp;在我们的美食大厨过程中，流处理和批处理就是对每一道菜肴的两种制作方式。当我们准备好一道菜的食材并做好处理后，便立即开始制作，这便是流处理；而当准备好一桌菜的食材并处理好后，在一个固定时间开始制作，这就是批处理。

&emsp;&emsp;在开始学习流处理和批处理之前，我们先对两对概念进行了解：

&emsp;&emsp;无边界数据和有边界数据
1. 无边界数据：是一种可以增长，无限的数据，无法判断它到底在什么时间能够结束增长，又称其为流数据（Streaming Data）。例如：我们生活中的app的日志数据，每时每刻都会有数据产生，无法判断它会什么时间能够停止。
2. 有边界数据：是一种保存好了的数据，也就是说不会发生变化的数据。例如：我们取一天内的app日志数据，那么该数据不会发生变化了，那么这一部分就是有边界数据。

&emsp;&emsp;事件时间和处理时间
1. 事件时间（Event Time）指的是一个数据产生的时间；
2. 处理时间（Precessing Time）指的是这条数据实际被系统接受的时间。

&emsp;&emsp;举一个易理解的例子：我打开票务app抢一个演唱会的门票，我在20:01进入了支付界面，但是由于服务器人数过多，导致该订单一直在重复支付，直到两分钟后服务器恢复正常，提示支付成功，现在时间为20:03。这里的20:01就是事件时间，而20:03就是处理时间。

### 4.4.1 流处理（Stream Processing）

&emsp;&emsp;流处理是一种实时或近实时处理数据流的模式，数据在生成后立即被处理，无需等待所有数据收集完毕。数据的流处理可以理解为系统需要接受并处理一系列连续不断变化的数据。例如，短视频的实时推荐。

&emsp;&emsp;流处理的输入基本都是无边界数据。而流处理系统中是关心事件时间还是处理时间一般是随应用场景而定的。例如：像网页监控系统这样的流处理系统要计算网站的QPS，它关心的更多是处理时间，也就是网页请求数据被监控系统接收到的时间，而计算QPS。而在一些医疗护理监控系统的流处理系统中，他们则关心数据的事件时间，这种系统不会因为网络延迟而忽略系统原本产生的时间。

&emsp;&emsp;流处理的特点：
1. 实时性：处理延迟低（毫秒到秒级），适合对时效性要求高的场景。
2. 无界数据：处理连续、无边界的数据流（如传感器数据、日志流、交易记录）。
3. 逐条或微批处理：数据以单条记录或小批次（微批）形式处理。
4. 状态管理：需要维护中间状态（如窗口聚合、会话跟踪）。

&emsp;&emsp;流处理快的原因，是因为他是在数据未达到磁盘时计算的，也就是在内存中计算的。

&emsp;&emsp;流处理的典型应用场景：
1. 实时监控：金融检测，电话诈骗检测，捕获和分析各种来源发布的数据，点击网页；
2. 实时推荐：短视频推荐，电商平台对用户行为的实时分析；
3. 销售终端（POS）系统：股票价格的更新，允许用户实时完成付款的系统。

&emsp;&emsp;如今开源的生态圈中，入Apache Kafka、Apache Storm、Apache Flink、Apache Samza等都是流行的流处理架构平台。

### 4.4.2 批处理（Batch Processing）

&emsp;&emsp;批处理是一种离线处理大规模静态数据集的模式，数据被收集后按固定批次（如每小时/每天）统一处理。数据的批处理可以理解为一系列相关的任务按顺序或并行的，一个接一个地执行。批处理地输入是在一段时间内收集好地数据。每次批处理地输出都可以是下次批处理地输入。例如：微信支付日报，美团年支付报告。

&emsp;&emsp;批处理的输入数据和输出数据在大多数情况下都是有边界数据，所以在批处理中系统中更关注的是事件时间。例如：每年的美团app都会将我们一年的消费记录保存下来，作为批处理的数据来源，经过一系列的分析计算得到一份有趣的数据作为数据输出。在大部分情况，批处理任务会被安排，并在预先设定好的事件间隔来执行。例如：一年、一个月、一天的特定时间。

&emsp;&emsp;批处理的特点：
1. 高吞吐量：适合处理大量数据，但延迟较高（分钟到小时级）。
2. 有界数据：处理的是已存储的、完整的数据集（如日志文件、数据库快照）。
3. 全量计算：一次性处理整个数据集，通常用于生成全局结果。
4. 容错性强：失败后可重新处理整个批次，状态管理简单。

&emsp;&emsp;批处理的典型应用场景：
1. 日志分析：日志系统是在一定时间段内收集的。而日志系统的数据处理分析是在不同的时间内执行的，以得到系统的关键性指标（例如之前说的准确性和系统容量等）。
2. 数据仓库：数据仓库的主要目标是根据收集好的数据事件时间，将数据信息合并为静态快照，并将它们聚合为每周、每月、每季度的报告等。
3. 计费的应用程序：计费应用程序会计算出一段时间内一项服务的使用程度，并生成计费信息，例如支付宝花呗的还款账单。

&emsp;&emsp;像现在的Apache Hadoop或者是Apache Spark等开源框架都是支持这种大数据批处理架构的。

### 4.4.3 流处理和批处理的区别和关联

&emsp;&emsp;核心区别：
1. 数据处理时机：流处理是实时处理（数据产生即处理），批处理是延迟处理（数据积累后处理）；
2. 数据边界：流处理是无边界数据（连续不断），批处理是有边界数据（固定大小）；
3. 延迟要求：流处理是低延迟（毫秒到秒级），批处理是高延迟（分钟到小时级）；
4. 资源消耗：流处理是长期运行，需稳定资源，批处理是短时高负载，资源释放快；
5. 容错机制：流处理是需复杂状态恢复（如检查点机制），批处理是简单重试（重新处理整个批次）；
6. 应用场景：流处理应用的是实时结果（如告警、实时仪表盘），批处理应用的是离线结果（如报表、分析报告）。

&emsp;&emsp;二者关联：

&emsp;&emsp;混合架构（Lambda/Kappa 架构）：
1. Lambda 架构：结合流式处理（实时层）和批处理（批处理层），通过服务层合并结果（如实时统计 + 离线修正）。
2. Kappa 架构：仅用流式处理，通过重放历史数据流来替代批处理（依赖高性能流处理框架如 Flink）。

&emsp;&emsp;技术融合：
1. 现代框架（如 Apache Spark、Flink）支持流批一体（同一 API 处理流和批数据）。
2. 微批处理（Micro-Batching）：将流式数据按小批次处理（如 Spark Streaming），兼顾实时性和吞吐量。

&emsp;&emsp;数据互补：
1. 批处理可为流式处理提供历史数据基准（如模型训练）。
2. 流式处理可为批处理提供实时增量更新（如实时数据预聚合）。

&emsp;&emsp;无论是批处理模式还是流处理模式，在现实中都是广泛的被使用，而采用哪种处理模式，则应当由使用场景决定。像是对不需要实时分析结果的情况下，其实批处理是一个很好的选择。特别是业务逻辑十分复杂，数据量大的时候，更容易从数据中挖掘到有用的信息。而对应用的实时分析处理有要求的情况下，或者数据传输的结束时间、数据量无法确定的情况下，就可以采用流处理的处理架构来完成这件事情


